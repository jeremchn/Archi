<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Companion - Sales Chatbot</title>
    <style>
        body { background: #f7fafc; font-family: 'Segoe UI', 'Roboto', Arial, sans-serif; margin: 0; padding: 0; }
        .chat-container { max-width: 600px; margin: 3em auto; background: #fff; border-radius: 16px; box-shadow: 0 2px 16px rgba(26,54,93,0.10); padding: 2em 2em 1.5em 2em; }
        h2 { color: #1a365d; text-align: center; margin-bottom: 1.2em; }
        .chat-history { min-height: 220px; max-height: 350px; overflow-y: auto; background: #f3f7fa; border-radius: 10px; padding: 1em; margin-bottom: 1.2em; display:none; }
        .msg { margin-bottom: 1em; }
        .msg.user { text-align: right; }
        .msg.ai { text-align: left; }
        .msg .bubble { display: inline-block; padding: 0.7em 1.1em; border-radius: 16px; max-width: 80%; font-size: 1.08em; }
        .msg.user .bubble { background: #eaf6ff; color: #1a365d; }
        .msg.ai .bubble { background: #eafaf1; color: #222; }
        .chat-input { display: flex; gap: 0.7em; }
        .chat-input input { flex: 1; padding: 0.8em 1em; border-radius: 8px; border: 1px solid #e2e8f0; font-size: 1.05em; }
        .chat-input button { background: #1a365d; color: #fff; border: none; border-radius: 8px; padding: 0.7em 1.5em; font-size: 1.05em; cursor: pointer; transition: background 0.2s; }
        .chat-input button:hover { background: #2ecc71; }
        @media (max-width: 700px) { .chat-container { padding: 1em; } }
    </style>
</head>
<body>
<div class="chat-container">
    <h2>AI Companion - Sales Chatbot</h2>
    <form class="chat-input" id="chat-form" autocomplete="off" style="margin-bottom:1.2em;">
        <input type="text" id="chat-input" placeholder="Posez votre question commerciale..." required />
        <button type="submit">Envoyer</button>
    </form>
    <div class="chat-history" id="chat-history" style="display:none;"></div>
</div>
<script>
const chatHistory = document.getElementById('chat-history');
const chatForm = document.getElementById('chat-form');
const chatInput = document.getElementById('chat-input');

function addMessage(text, sender) {
    const msg = document.createElement('div');
    msg.className = 'msg ' + sender;
    if (sender === 'ai') {
        // Affiche les retours à la ligne de l'IA
        let safe = (typeof text === 'string') ? text.replace(/[&<>]/g, tag => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[tag])).replace(/\n/g, '<br>') : '';
        safe = safe.replace(/&lt;br&gt;/g, '<br>');
        msg.innerHTML = `<span class="bubble">${safe}</span>`;
    } else {
        // Pour l'utilisateur, pas de HTML
        msg.innerHTML = `<span class="bubble"></span>`;
        msg.querySelector('.bubble').textContent = text;
    }
    chatHistory.appendChild(msg);
    chatHistory.style.display = '';
    chatHistory.scrollTop = chatHistory.scrollHeight;
}

let chatHistoryArr = [];
chatForm.onsubmit = async function(e) {
    e.preventDefault();
    const question = chatInput.value.trim();
    if (!question) {
        alert('Veuillez saisir une question.');
        return;
    }
    addMessage(question, 'user');
    chatInput.value = '';
    chatHistoryArr.push({ role: 'user', content: question });
    chatHistory.style.display = '';
    addMessage('<span class="loader" style="display:inline-block;width:18px;height:18px;border:3px solid #e2e8f0;border-top:3px solid #1a365d;border-radius:50%;animation:spin 1s linear infinite;vertical-align:middle;"></span> Réflexion AI...', 'ai');
    try {
        if (!chatHistoryArr.length) throw new Error('Aucun message à envoyer.');
        // Récupère le profil depuis le localStorage
        const profile = JSON.parse(localStorage.getItem('companyProfile') || '{}');
        if (!profile || Object.keys(profile).length === 0) {
            throw new Error('Profil entreprise manquant.');
        }
        const res = await fetch('/api/sales-chatbot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ messages: chatHistoryArr, profile })
        });
        let data = null;
        try { data = await res.json(); } catch { data = {}; }
        console.log('Réponse backend chatbot:', data); // LOG DEBUG
        // Supprime le loader
        const lastMsg = chatHistory.querySelector('.msg.ai:last-child');
        if (lastMsg) lastMsg.remove();
        if (res.ok) {
            if (data.answer && typeof data.answer === 'string' && data.answer.trim()) {
                addMessage(data.answer, 'ai');
                chatHistoryArr.push({ role: 'assistant', content: data.answer });
            } else if (data.error && data.error.includes('OPENAI')) {
                addMessage("Erreur OpenAI : clé API manquante ou invalide.", 'ai');
            } else {
                addMessage("Aucune réponse générée par l'IA.", 'ai');
            }
        } else {
            addMessage('Erreur lors de la génération de la réponse AI.', 'ai');
        }
    } catch (e) {
        const lastMsg = chatHistory.querySelector('.msg.ai:last-child');
        if (lastMsg) lastMsg.remove();
        addMessage('Erreur réseau, serveur ou profil manquant.', 'ai');
    }
};
</script>
</body>
</html>
