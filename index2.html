<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Company Profile ‚Äì AI Sales</title>
  <style>
    :root {
      --primary: #1a365d;
      --secondary: #2ecc71;
      --background: #f7fafc;
      --card-bg: #fff;
      --text: #222;
      --border: #e2e8f0;
      --shadow: 0 2px 12px rgba(26,54,93,0.08);
      --danger: #e74c3c;
      --success: #27ae60;
      --gray: #e2e8f0;
    }
    html, body {
      background: var(--background);
      color: var(--text);
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .layout {
      display: flex;
      min-height: 100vh;
    }
    aside.menu {
      background: #f3f7fa;
      border-right: 1.5px solid #e2e8f0;
      padding: 2em 1.2em;
      display: flex;
      flex-direction: column;
      gap: 2em;
      min-width: 210px;
      position: relative;
    }
    .menu ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 1.2em;
    }
    .menu li {
      margin-bottom: 0.7em;
      cursor: pointer;
      color: var(--primary);
      font-weight: 500;
      padding: 0.3em 0.5em;
      border-radius: 6px;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 0.7em;
    }
    .menu li.active, .menu li:hover {
      background: var(--secondary);
      color: #fff;
    }
    .menu .bottom-btns {
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 1em;
    }
    .btn {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.5em 1.2em;
      font-size: 1.05em;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      box-shadow: 0 1px 4px rgba(26,54,93,0.08);
      min-width: 120px;
    }
    .btn:hover, .btn:focus {
      background: var(--secondary);
      color: #fff;
      transform: translateY(-2px) scale(1.03);
    }
    .btn:active {
      background: #145;
    }
    .btn[disabled] {
      background: #bfc9d1;
      color: #fff;
      cursor: not-allowed;
    }
    .container {
      max-width: 1100px;
      margin: 2em auto;
      padding: 2em 2.5em;
      background: var(--card-bg);
      border-radius: 18px;
      box-shadow: var(--shadow);
      animation: fadeIn 0.7s;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: none; }
    }
    h1 {
      color: var(--primary);
      margin-top: 0;
      margin-bottom: 1.5em;
      letter-spacing: 1px;
      font-size: 2.2em;
      text-align: center;
    }
    .profile-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2.5em 2em;
      align-items: start;
    }
    .profile-col {
      background: #f7fafc;
      border-radius: 14px;
      box-shadow: 0 1px 6px rgba(26,54,93,0.06);
      padding: 2em 1.5em 1.5em 1.5em;
      min-width: 0;
    }
    .profile-col h2 {
      color: var(--primary);
      font-size: 1.25em;
      margin-top: 0;
      margin-bottom: 1.2em;
      text-align: left;
    }
    .profile-field {
      margin-bottom: 1.2em;
    }
    .profile-field label {
      font-weight: 600;
      margin-bottom: 0.3em;
      display: block;
    }
    .profile-field input, .profile-field textarea {
      width: 100%;
      padding: 0.7em;
      border-radius: 7px;
      border: 1px solid #e2e8f0;
      font-size: 1em;
      margin-top: 0.2em;
      background: #fff;
      color: var(--text);
    }
    .profile-field textarea {
      resize: vertical;
      min-height: 60px;
    }
    .file-list {
      font-size: 0.97em;
      color: #1a365d;
      margin-top: 0.3em;
    }
    .profile-actions {
      text-align: center;
      margin-top: 2em;
      grid-column: 1/3;
    }
    .profile-summary {
      font-size: 1.08em;
      line-height: 1.7;
      color: #1a365d;
    }
    .profile-summary ul {
      margin: 0.5em 0 0 1.2em;
      padding: 0;
    }
    @media (max-width: 900px) {
      .layout { flex-direction: column; }
      aside.menu { width: 100%; border-right: none; border-bottom: 1.5px solid var(--border); flex-direction: row; gap: 1em; }
      .container { max-width: 100vw; margin: 0; border-radius: 0; }
      .profile-grid { grid-template-columns: 1fr; gap: 1.5em 0; }
    }
    @media (max-width: 700px) {
      .container { padding: 1em; }
      .menu ul { gap: 0.5em; }
      .menu li { font-size: 0.98em; }
      .profile-col { padding: 1em 0.7em; }
    }
    .menu li#menu-aisales:hover, .menu li#menu-aisales.active {
      background: var(--secondary) !important;
      color: #fff !important;
    }
    .menu li#menu-contacts:hover, .menu li#menu-contacts.active {
      box-shadow: none !important;
      border-bottom: none !important;
    }
  </style>
</head>
<body>
<div class="layout">
  <aside class="menu" style="background:#f3f7fa;border-right:1.5px solid #e2e8f0;padding:2em 1.2em;display:flex;flex-direction:column;gap:2em;min-width:210px;position:relative;">
    <nav>
        <ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:1.2em;">
            <li id="menu-prompt" class="menu-item">
                <span style="font-size:1.2em;">üí°</span> <span>Prompt Finder</span>
            </li>
            <li id="menu-name" class="menu-item">
                <span style="font-size:1.2em;">üîç</span> <span>Domain Lookup</span>
            </li>
            <li id="menu-filter" class="menu-item">
                <span style="font-size:1.2em;">üß†</span> <span>Smart Filter Search</span>
            </li>
            <li id="menu-aisales" class="menu-item active" style="display:flex;align-items:center;gap:0.7em;cursor:pointer;padding:0.5em 0.7em;border-radius:7px;transition:background 0.2s;font-weight:600;color:#fff;background:var(--secondary);">
                <span style="font-size:1.2em;">ü§ñ</span> <span>AI Sales</span>
            </li>
            <li id="menu-chatbot" class="menu-item">
                <span style="font-size:1.2em;">üí¨</span> <span>AI Companion</span>
            </li>
            <li id="menu-saved" class="menu-item" style="margin-top:1.5em;font-weight:600;color:#1a365d;">
                <span style="font-size:1.2em;">üíæ</span> <span>Saved companies</span>
            </li>
            <li id="menu-contacts" class="menu-item">
                <span style="font-size:1.2em;">üë§</span> <span>Leads</span>
            </li>
            <li style="flex:1 1 auto;"></li>
        </ul>
    </nav>
    <button class="btn btn-gray" style="font-size:1em;padding:0.5em 1.1em;width:90%;position:absolute;left:5%;bottom:1.5em;" onclick="window.location.href='auth.html'">Logout</button>
</aside>
  <div class="container">
    <h1>Company Profile</h1>
    <div id="profile-edit" style="display:none;">
      <form id="profile-form" autocomplete="off" enctype="multipart/form-data">
        <div class="profile-grid">
          <div class="profile-col">
            <h2>Main Information</h2>
            <div class="profile-field">
              <label for="secteur">Sector</label>
              <input type="text" id="secteur" name="secteur" required>
            </div>
            <div class="profile-field">
              <label for="businessModel">Business Model</label>
              <input type="text" id="businessModel" name="businessModel">
            </div>
            <div class="profile-field">
              <label for="tailleEquipe">Team Size / Sales</label>
              <input type="text" id="tailleEquipe" name="tailleEquipe">
            </div>
            <div class="profile-field">
              <label for="marchesCibles">Target Markets</label>
              <input type="text" id="marchesCibles" name="marchesCibles">
            </div>
            <div class="profile-field">
              <label for="cycleVente">Average Sales Cycle</label>
              <input type="text" id="cycleVente" name="cycleVente">
            </div>
            <div class="profile-field">
              <label for="outilsUtilises">Tools Used</label>
              <input type="text" id="outilsUtilises" name="outilsUtilises">
            </div>
            <div class="profile-field">
              <label for="objectifs12mois">12-Month Objectives</label>
              <input type="text" id="objectifs12mois" name="objectifs12mois">
            </div>
            <div class="profile-field">
              <label for="caAnnuel">Estimated Annual Revenue</label>
              <input type="text" id="caAnnuel" name="caAnnuel">
            </div>
          </div>
          <div class="profile-col">
            <h2>Additional Information</h2>
            <div class="profile-field">
              <label for="dreamClient1">3 Dream Clients</label>
              <input type="text" id="dreamClient1" name="dreamClient1" placeholder="Dream Client 1" style="margin-bottom:0.5em;">
              <input type="text" id="dreamClient2" name="dreamClient2" placeholder="Dream Client 2" style="margin-bottom:0.5em;">
              <input type="text" id="dreamClient3" name="dreamClient3" placeholder="Dream Client 3">
            </div>
            <div class="profile-field">
              <label for="uvp">Unique Value Proposition</label>
              <input type="text" id="uvp" name="uvp">
            </div>
            <div class="profile-field">
              <label for="champsLibre">Free Field, Company Data</label>
              <textarea id="champsLibre" name="champsLibre" rows="3"></textarea>
            </div>
            <div class="profile-field">
              <label for="fileUpload">Import files (PDF, CSV, etc.)</label>
              <input type="file" id="fileUpload" name="fileUpload" accept=".pdf,.csv,.xlsx,.xls,.txt,.doc,.docx,.json" multiple>
              <div id="fileList" class="file-list"></div>
              <ul id="importedDocsList" class="file-list"></ul>
            </div>
          </div>
          <div class="profile-actions">
            <button type="submit" class="btn btn-search" style="width:220px;">Save Profile</button>
          </div>
        </div>
      </form>
      <div id="profile-feedback" style="margin-top:1em;text-align:center;"></div>
    </div>
    <div id="profile-summary" style="display:none;">
      <h2 style="text-align:center;margin-bottom:1.2em;">Profile Summary</h2>
      <div class="profile-grid">
        <div class="profile-col">
          <div class="profile-summary" id="summary-main"></div>
        </div>
        <div class="profile-col">
          <div class="profile-summary" id="summary-side"></div>
        </div>
        <div class="profile-actions">
          <button id="editProfileBtn" class="btn btn-gray" style="width:220px;">Edit</button>
        </div>
      </div>
    </div>
    <footer style="margin-top:2.5em;text-align:center;color:#888;font-size:0.98em;opacity:0.8;">
      &copy; 2025 Lydi. All rights reserved.
    </footer>
  </div>
</div>
<script>
// --- Robust left menu navigation (anchors for index.html) ---
document.addEventListener('DOMContentLoaded', function() {
  const menuLinks = [
    { id: 'menu-prompt', href: 'index.html#prompt' },
    { id: 'menu-name', href: 'index.html#domain' },
    { id: 'menu-filter', href: 'index.html#filter' },
    { id: 'menu-aisales', href: 'index2.html' },
    { id: 'menu-chatbot', href: 'chatbot.html' },
    { id: 'menu-saved', href: 'saved.html' },
    { id: 'menu-contacts', href: 'contacts.html' }
  ];
  menuLinks.forEach(link => {
    const el = document.getElementById(link.id);
    if (el) {
      el.style.cursor = 'pointer';
      el.addEventListener('click', function(e) {
        e.preventDefault();
        window.location.href = link.href;
      });
    }
  });
  // Logout button logic
  const logoutBtn = document.querySelector('.btn.btn-gray[onclick]');
  if (logoutBtn) {
    logoutBtn.onclick = null;
    logoutBtn.style.cursor = 'pointer';
    logoutBtn.addEventListener('click', function(e) {
      e.preventDefault();
      // Optionally clear localStorage/session
      localStorage.clear();
      window.location.href = 'auth.html';
    });
  }
});

// --- Gestion du mode √©dition/r√©sum√© ---
const editDiv = document.getElementById('profile-edit');
const summaryDiv = document.getElementById('profile-summary');
const form = document.getElementById('profile-form');
const fileInput = document.getElementById('fileUpload');
const fileList = document.getElementById('fileList');
const feedback = document.getElementById('profile-feedback');
const summaryMain = document.getElementById('summary-main');
const summarySide = document.getElementById('summary-side');
const importedDocsList = document.getElementById('importedDocsList');

async function uploadProfileFiles(files, email) {
  if (!files || files.length === 0) return [];
  const formData = new FormData();
  for (let i = 0; i < files.length; i++) {
    formData.append('files', files[i]);
  }
  formData.append('email', email || '');
  try {
    const res = await fetch('/api/upload-profile-files', {
      method: 'POST',
      body: formData
    });
    if (!res.ok) throw new Error('Erreur upload fichiers');
    const data = await res.json();
    return data.uploadedFiles || [];
  } catch (e) {
    feedback.innerHTML = '<span style="color:var(--danger);font-weight:600;">Erreur lors de l\'upload des fichiers</span>';
    setTimeout(() => { feedback.innerHTML = ''; }, 3000);
    return [];
  }
}

function getProfileData() {
  const data = {};
  if (!form) return data;
  const fd = new FormData(form);
  for (const [k, v] of fd.entries()) data[k] = v;
  // Ajout fichiers (noms)
  if (fileInput && fileInput.files.length > 0) {
    data.uploadedFiles = Array.from(fileInput.files).map(f => f.name);
  } else if (window._lastFiles) {
    data.uploadedFiles = window._lastFiles;
  } else {
    data.uploadedFiles = [];
  }
  // Ajoute l'email utilisateur au profil (pour le RAG)
  data.email = localStorage.getItem('email') || '';
  return data;
}

function setProfileData(data) {
  if (!form) return;
  for (const [k, v] of Object.entries(data)) {
    // Ne pas essayer de pr√©-remplir le champ fichier (fileUpload) ni uploadedFiles
    if (k === 'fileUpload' || k === 'uploadedFiles') continue;
    if (form.elements[k]) form.elements[k].value = v;
  }
  // Affiche la liste des fichiers (noms)
  if (data.uploadedFiles && data.uploadedFiles.length) {
    fileList.textContent = 'Fichiers s√©lectionn√©s : ' + data.uploadedFiles.join(', ');
    window._lastFiles = data.uploadedFiles;
  } else {
    fileList.textContent = '';
    window._lastFiles = [];
  }
  // Vide le champ fichier √† chaque passage en √©dition
  if (fileInput) fileInput.value = '';
}

function showEdit() {
  editDiv.style.display = '';
  summaryDiv.style.display = 'none';
  // Effet visuel pour montrer le passage en √©dition
  setTimeout(() => {
    if (form) form.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 50);
}
function showSummary(data) {
  // Main column
  summaryMain.innerHTML =
    `<b>Sector:</b> ${data.secteur || '-'}<br>` +
    `<b>Business Model:</b> ${data.businessModel || '-'}<br>` +
    `<b>Team Size:</b> ${data.tailleEquipe || '-'}<br>` +
    `<b>Target Markets:</b> ${data.marchesCibles || '-'}<br>` +
    `<b>Sales Cycle:</b> ${data.cycleVente || '-'}<br>` +
    `<b>Tools:</b> ${data.outilsUtilises || '-'}<br>` +
    `<b>12-Month Objectives:</b> ${data.objectifs12mois || '-'}<br>` +
    `<b>Estimated Annual Revenue:</b> ${data.caAnnuel || '-'}<br>`;
  // Side column
  summarySide.innerHTML =
    `<b>Dream Clients:</b> ${[data.dreamClient1, data.dreamClient2, data.dreamClient3].filter(Boolean).join(', ') || '-'}<br>` +
    `<b>Unique Value Proposition:</b> ${data.uvp || '-'}<br>` +
    `<b>Free Field:</b> ${data.champsLibre || '-'}<br>` +
    `<b>Imported Files:</b> <ul>` +
    ((data.uploadedFiles && data.uploadedFiles.length) ? data.uploadedFiles.map(f => `<li>${f}</li>`).join('') : '<li><i>No file</i></li>') +
    `</ul>`;
  editDiv.style.display = 'none';
  summaryDiv.style.display = '';
  // Attach event to Edit button
  setTimeout(() => {
    const editBtn = document.getElementById('editProfileBtn');
    if (editBtn) {
      editBtn.onclick = function() {
        setProfileData(data);
        showEdit();
      };
    }
  }, 0);
}

// Gestion fichiers (affichage noms)
if (fileInput && fileList) {
  fileInput.addEventListener('change', function() {
    if (fileInput.files.length === 0) {
      fileList.textContent = '';
      window._lastFiles = [];
      return;
    }
    let names = Array.from(fileInput.files).map(f => f.name);
    fileList.textContent = 'Fichiers s√©lectionn√©s : ' + names.join(', ');
    window._lastFiles = names;
  });
}

// --- Gestion des documents import√©s (affichage, suppression) ---
async function fetchImportedDocs() {
  const email = localStorage.getItem('email') || '';
  if (!email) return;
  try {
    const res = await fetch(`/api/get-imported-docs?email=${encodeURIComponent(email)}`);
    const data = await res.json();
    renderImportedDocs(data.files || []);
  } catch {
    renderImportedDocs([]);
  }
}

function renderImportedDocs(files) {
  importedDocsList.innerHTML = '';
  if (!files.length) {
    importedDocsList.innerHTML = '<li><i>No documents imported.</i></li>';
    return;
  }
  files.forEach(filename => {
    const li = document.createElement('li');
    li.textContent = filename + ' ';
    const delBtn = document.createElement('button');
    delBtn.textContent = 'Delete';
    delBtn.style.background = '#e74c3c';
    delBtn.style.color = '#fff';
    delBtn.style.border = 'none';
    delBtn.style.borderRadius = '6px';
    delBtn.style.padding = '4px 14px';
    delBtn.style.marginLeft = '10px';
    delBtn.style.cursor = 'pointer';
    delBtn.onclick = async function() {
      await deleteImportedDoc(filename);
      fetchImportedDocs();
    };
    li.appendChild(delBtn);
    importedDocsList.appendChild(li);
  });
}

async function deleteImportedDoc(filename) {
  const email = localStorage.getItem('email') || '';
  if (!email || !filename) return;
  await fetch('/api/delete-imported-doc', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, filename })
  });
}

// Soumission du formulaire
if (form) {
  form.onsubmit = async function(e) {
    e.preventDefault();
    const data = getProfileData();
    // R√©cup√®re l'email utilisateur (depuis localStorage ou champ cach√© si besoin)
    let email = localStorage.getItem('email') || data.email || '';
    // Upload fichiers si pr√©sents
    let uploadedFiles = [];
    if (fileInput && fileInput.files.length > 0) {
      uploadedFiles = await uploadProfileFiles(fileInput.files, email);
      data.uploadedFiles = uploadedFiles;
      fetchImportedDocs();
    }
    localStorage.setItem('companyProfile', JSON.stringify(data));
    showSummary(data);
    feedback.innerHTML = '<span style="color:var(--success);font-weight:600;">Profile saved!</span>';
    setTimeout(() => { feedback.innerHTML = ''; }, 2000);
  };
}

// Initialisation : affiche le bon mode
(function init() {
  const data = JSON.parse(localStorage.getItem('companyProfile') || '{}');
  if (data && Object.keys(data).length > 0 && Object.values(data).some(v => v && v !== '')) {
    showSummary(data);
  } else {
    showEdit();
  }
  setProfileData(data);
  fetchImportedDocs();
})();
</script>
</body>
</html>
